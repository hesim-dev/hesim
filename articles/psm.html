<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Partitioned survival models • hesim</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/simplex/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Partitioned survival models">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-131661920-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-131661920-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">hesim</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">API</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/intro.html">Introduction to hesim</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Cohort discrete time state transition models</li>
    <li>
      <a href="../articles/markov-cohort.html">Simple Markov cohort model</a>
    </li>
    <li>
      <a href="../articles/markov-inhomogeneous-cohort.html">Time inhomogeneous Markov cohort models</a>
    </li>
    <li>
      <a href="../articles/mlogit.html">Markov models with multinomial logistic regression</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Individual continuous time state transition models</li>
    <li>
      <a href="../articles/markov-inhomogeneous-indiv.html">Time inhomogeneous Markov individual-level models</a>
    </li>
    <li>
      <a href="../articles/mstate.html">Markov and semi-Markov multi-state models</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Partitioned survival analysis</li>
    <li>
      <a href="../articles/psm.html">N-state partitioned survival models</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Decision analysis</li>
    <li>
      <a href="../articles/cea.html">Cost-effectiveness analysis</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/benchmarks.html">Benchmarks</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/hesim-dev/hesim/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Partitioned survival models</h1>
            
            <h4 data-toc-skip class="date">2025-04-25</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/hesim-dev/hesim/blob/main/vignettes/psm.Rmd" class="external-link"><code>vignettes/psm.Rmd</code></a></small>
      <div class="hidden name"><code>psm.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>An N-state partitioned survival model (PSM) simulates the probability
that a patient is in each of N distinct health states at a given point
of time when treated by a particular therapy. State membership is
estimated from a set of non-mutually exclusive survival curves; for an
N-state model, N-1 survival curves are required.</p>
<p>The cumulative survival function,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>n</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">S_n(t)</annotation></semantics></math>,
represents the probability that a patient survives to health state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
or to a lower indexed state beyond time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>.
The probability that a patient is in health state 1 is always just
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mn>1</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">S_1(t)</annotation></semantics></math>.
State membership in health states
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>n</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2,\ldots, n-1</annotation></semantics></math>
is calculated as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>n</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><msub><mi>S</mi><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">S_{n}(t) - S_{n-1}(t)</annotation></semantics></math>.
Finally, the probability of being in the final health state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>
(i.e., the dead state) is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>−</mo><msub><mi>S</mi><mrow><mi>N</mi><mo>−</mo><mn>1</mn></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">1-S_{N-1}(t)</annotation></semantics></math>,
or one minus the overall survival curve.</p>
<p>In <code>hesim</code>, an N-state PSM consists of three types of
separate statistical models: a set of N-1 survival models, a model of
the utility values to assign to each health state, and a set of models
for costs to assign to each health state. Multiple cost models can be
used to categorize costs into different categories (e.g., costs of
medical care, drug costs). All models can either be fit using R or
constructed with external data.</p>
<p>Separate survival curves as a function of time,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>,
are predicted for each treatment strategy
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
and patient
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
as a function of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>L</mi><annotation encoding="application/x-tex">L</annotation></semantics></math>
parameters,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>α</mi><mi>l</mi></msub><annotation encoding="application/x-tex">\alpha_l</annotation></semantics></math>,
which can depend on covariates,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>x</mi><mi>l</mi></msub><annotation encoding="application/x-tex">x_l</annotation></semantics></math>
(see <code><a href="../reference/params_surv.html">params_surv()</a></code> for more details),</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>S</mi><mi>n</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="false" form="prefix">|</mo><msub><mi>α</mi><mrow><mn>1</mn><mi>n</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mrow><mn>1</mn><mi>n</mi><mo>,</mo><mi>i</mi><mi>k</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><mi>…</mi><mo>,</mo><msub><mi>α</mi><mrow><mi>L</mi><mi>n</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mrow><mi>L</mi><mi>n</mi><mo>,</mo><mi>i</mi><mi>k</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
S_{n}(t|\alpha_{1n}(x_{1n, ik}), \ldots, \alpha_{Ln}(x_{Ln, ik})).
\end{aligned}
</annotation></semantics></math> Quality-adjusted life-years (QALYs) and
total costs associated with a given health state for a given treatment
strategy and patient are calculated by integrating the “weighted”
probability of survival, where weights are a function of the discount
factor and predicted state values. Letting
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>h</mi><annotation encoding="application/x-tex">h</annotation></semantics></math>
index a health state, QALYs and total costs for the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>m</mi><annotation encoding="application/x-tex">m</annotation></semantics></math>th
cost category are calculated as,</p>
<p><span class="math display">$$
\begin{aligned}
\rm{QALYs}_{hik} &amp;= \int_{0}^{T} q_{hik}(t) e^{-rt} p_{hik}(t)dt, \\
\rm{Costs}_{m,hik} &amp;= \int_{0}^{T} c_{m,hik}(t) e^{-rt}
p_{hik}(t)dt,
\end{aligned}
$$</span> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>q</mi><mrow><mi>h</mi><mi>i</mi><mi>k</mi></mrow></msub><annotation encoding="application/x-tex">q_{hik}</annotation></semantics></math>
is a quality-of-life weight,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>c</mi><mrow><mi>m</mi><mo>,</mo><mi>h</mi><mi>i</mi><mi>k</mi></mrow></msub><annotation encoding="application/x-tex">c_{m,hik}</annotation></semantics></math>
is (assuming that time is measured in years) annualized costs,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>r</mi><annotation encoding="application/x-tex">r</annotation></semantics></math>
is the discount rate, and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi>h</mi><mi>i</mi><mi>k</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">p_{hik}(t)</annotation></semantics></math>
is the probability of being in a given health state at a given time, and
QALYs and costs are calculated over
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>
time periods.</p>
</div>
<div class="section level2">
<h2 id="an-example-4-state-psm">An example 4-state PSM<a class="anchor" aria-label="anchor" href="#an-example-4-state-psm"></a>
</h2>
<p>To illustrate a partitioned survival analysis, consider the
evaluation of a two-line sequential treatment strategy in oncology using
a 4-state PSM. The 4 health states might be:</p>
<ul>
<li>Progression free on first line treatment</li>
<li>Progression free on second line treatment</li>
<li>Progressed on second line treatment</li>
<li>Death</li>
</ul>
<p>We begin by defining the population, treatment strategies, and model
structure. In this example, we model three treatment strategies, three
distinct patients (that differ in age and gender), and four health
states (death and three non-death states). This information is combined
using <code><a href="../reference/hesim_data.html">hesim_data()</a></code>, which creates a general object of class
<code>hesim_data</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://r-datatable.com" class="external-link">"data.table"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://hesim-dev.github.io/hesim/">"hesim"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">101</span><span class="op">)</span></span>
<span><span class="va">strategies</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>strategy_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>                         strategy_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Strategy "</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">patients</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>patient_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>                       age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">45</span>, <span class="fl">50</span>, <span class="fl">60</span><span class="op">)</span>,</span>
<span>                       female <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">states</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>state_id <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>                     state_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Progression free (1st line)"</span>,</span>
<span>                                    <span class="st">"Progression free (2nd line)"</span>,</span>
<span>                                    <span class="st">"Progressed (2nd line)"</span><span class="op">)</span>,</span>
<span>                        stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">hesim_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hesim_data.html">hesim_data</a></span><span class="op">(</span>strategies <span class="op">=</span> <span class="va">strategies</span>,</span>
<span>                        patients <span class="op">=</span> <span class="va">patients</span>,</span>
<span>                        states <span class="op">=</span> <span class="va">states</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">hesim_dat</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $strategies</span></span>
<span><span class="co">##    strategy_id strategy_name</span></span>
<span><span class="co">##          &lt;num&gt;        &lt;char&gt;</span></span>
<span><span class="co">## 1:           1    Strategy 1</span></span>
<span><span class="co">## 2:           2    Strategy 2</span></span>
<span><span class="co">## 3:           3    Strategy 3</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $patients</span></span>
<span><span class="co">##    patient_id   age female</span></span>
<span><span class="co">##         &lt;int&gt; &lt;num&gt;  &lt;num&gt;</span></span>
<span><span class="co">## 1:          1    45      0</span></span>
<span><span class="co">## 2:          2    50      0</span></span>
<span><span class="co">## 3:          3    60      1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $states</span></span>
<span><span class="co">##   state_id                  state_name</span></span>
<span><span class="co">## 1        1 Progression free (1st line)</span></span>
<span><span class="co">## 2        2 Progression free (2nd line)</span></span>
<span><span class="co">## 3        3       Progressed (2nd line)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attr(,"class")</span></span>
<span><span class="co">## [1] "hesim_data"</span></span></code></pre>
<p>We use <code><a href="../reference/get_labels.html">get_labels()</a></code> to obtain nice labels for plots and
summary tables.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">labs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_labels.html">get_labels</a></span><span class="op">(</span><span class="va">hesim_dat</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">labs</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $strategy_id</span></span>
<span><span class="co">## Strategy 1 Strategy 2 Strategy 3 </span></span>
<span><span class="co">##          1          2          3 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $state_id</span></span>
<span><span class="co">## Progression free (1st line) Progression free (2nd line) </span></span>
<span><span class="co">##                           1                           2 </span></span>
<span><span class="co">##       Progressed (2nd line)                       Death </span></span>
<span><span class="co">##                           3                           4</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="parameter-estimation">Parameter estimation<a class="anchor" aria-label="anchor" href="#parameter-estimation"></a>
</h2>
<div class="section level3">
<h3 id="survival-models">Survival models<a class="anchor" aria-label="anchor" href="#survival-models"></a>
</h3>
<p>The parameters of the survival models would typically be estimated in
one of two ways. First, if access to patient level data from a clinical
trial were available, survival models would be fit using available R
packages. Second, a formal evidence synthesis—such as a network
meta-analysis—might be conducted. Here, we provide an example of an
analysis with trial level data.</p>
<p>We consider an estimation dataset (<code>surv_est_data</code>) with
three survival endpoints with endpoint 1 denoting the lowest indexed
state, endpoint 2 the next indexed state, and endpoint 3 representing
overall survival. In our example, endpoint 1 represents progression on
1st line treatment, endpoint 2 represents progression on 2nd line
treatment, and endpoint 3 represents death.</p>
<p>Survival models in <code>hesim</code> can be fit using either
<code>flexsurvreg</code> or <code>flexsurvspline</code> from the
<code>flexsurv</code> package. <code>hesim</code> currently supports
parametric (exponential, Weibull, Gompertz, gamma, log-logistic,
lognormal, and generalized gamma), splines, and fractional polynomial
survival models (see <a href="https://hesim-dev.github.io/hesim/reference/params_surv.html">params_surv</a>).
In this example, we fit a Weibull model to each of the three survival
endpoints.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/chjackson/flexsurv" class="external-link">"flexsurv"</a></span><span class="op">)</span></span>
<span><span class="va">surv_est_data</span> <span class="op">&lt;-</span> <span class="va">psm4_exdata</span><span class="op">$</span><span class="va">survival</span></span>
<span><span class="va">fit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://chjackson.github.io/flexsurv-dev/reference/flexsurvreg.html" class="external-link">flexsurvreg</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">endpoint1_time</span>, <span class="va">endpoint1_status</span><span class="op">)</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">female</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">strategy_id</span><span class="op">)</span>,</span>
<span>                    data <span class="op">=</span> <span class="va">surv_est_data</span>,</span>
<span>                    dist <span class="op">=</span> <span class="st">"weibull"</span><span class="op">)</span></span>
<span><span class="va">fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://chjackson.github.io/flexsurv-dev/reference/flexsurvreg.html" class="external-link">flexsurvreg</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">endpoint2_time</span>, <span class="va">endpoint2_status</span><span class="op">)</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">female</span> <span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">strategy_id</span><span class="op">)</span>,</span>
<span>                    data <span class="op">=</span> <span class="va">surv_est_data</span>,</span>
<span>                    dist <span class="op">=</span> <span class="st">"weibull"</span><span class="op">)</span></span>
<span><span class="va">fit3</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://chjackson.github.io/flexsurv-dev/reference/flexsurvreg.html" class="external-link">flexsurvreg</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">endpoint3_time</span>, <span class="va">endpoint3_status</span><span class="op">)</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">female</span> <span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">strategy_id</span><span class="op">)</span>,</span>
<span>                    data <span class="op">=</span> <span class="va">surv_est_data</span>,</span>
<span>                    dist <span class="op">=</span> <span class="st">"weibull"</span><span class="op">)</span></span>
<span><span class="va">psfit_wei</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flexsurvreg_list.html">flexsurvreg_list</a></span><span class="op">(</span><span class="va">fit1</span>, <span class="va">fit2</span>, <span class="va">fit3</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="utility-and-cost-models">Utility and cost models<a class="anchor" aria-label="anchor" href="#utility-and-cost-models"></a>
</h3>
<p>Although utility and cost models can be fit using regression models,
in many cases, we won’t fit a model directly, but will use estimated
mean values from published sources. In this case, we can use a
<code><a href="../reference/stateval_tbl.html">stateval_tbl()</a></code> to store estimates. For instance, consider
an example where we are only given a range of values for utility and we
therefore approximate the posterior distribution of mean utility values
by health state using a uniform distribution.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">utility_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stateval_tbl.html">stateval_tbl</a></span><span class="op">(</span>tbl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>state_id <span class="op">=</span> <span class="va">states</span><span class="op">$</span><span class="va">state_id</span>,</span>
<span>                                             min <span class="op">=</span> <span class="va">psm4_exdata</span><span class="op">$</span><span class="va">utility</span><span class="op">$</span><span class="va">lower</span>,</span>
<span>                                             max <span class="op">=</span> <span class="va">psm4_exdata</span><span class="op">$</span><span class="va">utility</span><span class="op">$</span><span class="va">upper</span><span class="op">)</span>,</span>
<span>                            dist <span class="op">=</span> <span class="st">"unif"</span><span class="op">)</span></span></code></pre></div>
<p>Similar to utility, we will not simulate drug costs based on a
statistical model but will instead use published estimates. Drug costs
will only vary by treatment strategy (i.e., they do not vary by health
state or across samples in the PSA).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">drugcost_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stateval_tbl.html">stateval_tbl</a></span><span class="op">(</span>tbl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>strategy_id <span class="op">=</span> <span class="va">strategies</span><span class="op">$</span><span class="va">strategy_id</span>,</span>
<span>                                           est <span class="op">=</span> <span class="va">psm4_exdata</span><span class="op">$</span><span class="va">costs</span><span class="op">$</span><span class="va">drugs</span><span class="op">$</span><span class="va">costs</span><span class="op">)</span>,</span>
<span>                          dist <span class="op">=</span> <span class="st">"fixed"</span><span class="op">)</span></span></code></pre></div>
<p>For cases in which we want to use a regression model to simulate
costs, <code>hesim</code> supports parameterizing a cost or utility
model using linear models. Here, we fit a model for medical costs as a
function of the three non-death health states using the
<code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> function in R.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">medcosts_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">costs</span> <span class="op">~</span> <span class="va">female</span> <span class="op">+</span> <span class="va">state_name</span>, data <span class="op">=</span> <span class="va">psm4_exdata</span><span class="op">$</span><span class="va">costs</span><span class="op">$</span><span class="va">medical</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="simulation">Simulation<a class="anchor" aria-label="anchor" href="#simulation"></a>
</h2>
<div class="section level3">
<h3 id="constructing-the-economic-model">Constructing the economic model<a class="anchor" aria-label="anchor" href="#constructing-the-economic-model"></a>
</h3>
<p>A PSM in <code>hesim</code> is an <a href="https://r6.r-lib.org/index.html" class="external-link">R6</a> object of class
<code>Psm</code> and comprises of three separate submodels: (1) a set of
survival models for generating survival curves (of class
<code>PsmCurves</code>), (2) a utility model (of class
<code>StateVals</code>), and (3) a set of cost models for each cost
component (a list of <code>StateVals</code> objects). Since analyses in
<code>hesim</code> are, by default, based on sampled values of the
parameters from their joint posterior distribution in order to
facilitate probabilistic sensitivity analysis (PSA), we will specify the
number of sampled parameter sets that are desired.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_samples</span> <span class="op">&lt;-</span> <span class="fl">100</span></span></code></pre></div>
<div class="section level4">
<h4 id="survival-models-1">Survival models<a class="anchor" aria-label="anchor" href="#survival-models-1"></a>
</h4>
<p>Survival curves are simulated using <code>PsmCurves</code> objects.
We can create a <code>PsmCurves</code> object using
<code><a href="../reference/create_PsmCurves.html">create_PsmCurves()</a></code> as a function of our fitted Weibull
models and input data describing the target population and treatment
strategies.</p>
<p>To conduct the PSA, we must sample random draws of the regression
coefficients from suitable probability distribution, which can be done
in one of two ways. First, the parameters of each survival model can be
sampled separately using a multivariate normal distribution. However,
this option does not preserve the correlation in the survival endpoints.
By default, <code><a href="../reference/create_PsmCurves.html">create_PsmCurves()</a></code> consequently samples the
parameters via bootstrapping, whereby the survival models are refit
repeatedly to resamples of the estimation dataset.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv_input_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/expand.html">expand</a></span><span class="op">(</span><span class="va">hesim_dat</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"strategies"</span>, <span class="st">"patients"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">survmods</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_PsmCurves.html">create_PsmCurves</a></span><span class="op">(</span><span class="va">psfit_wei</span>, input_data <span class="op">=</span> <span class="va">surv_input_data</span>, n <span class="op">=</span> <span class="va">n_samples</span>,</span>
<span>                               uncertainty <span class="op">=</span> <span class="st">"bootstrap"</span>, est_data <span class="op">=</span> <span class="va">surv_est_data</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="utility-and-cost-models-1">Utility and cost models<a class="anchor" aria-label="anchor" href="#utility-and-cost-models-1"></a>
</h4>
<p>Utility and cost values are simulated using models of class
<code>StateVals</code>. We can instantiate a <code>StateVals</code>
object from a ’stateval_tbl` object, which creates a “mean model” that
predicts mean state values for each treatment strategy, patient, and
health state combination. In the utility model, utility only varies
across health states and is constant within patients and treatment
strategies conditional on health state.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">utilitymod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_StateVals.html">create_StateVals</a></span><span class="op">(</span><span class="va">utility_tbl</span>, n <span class="op">=</span> <span class="va">n_samples</span>, hesim_data <span class="op">=</span> <span class="va">hesim_dat</span><span class="op">)</span></span></code></pre></div>
<p>We take a similar approach for drug costs, in which costs only vary
across treatment strategies.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">drugcostmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_StateVals.html">create_StateVals</a></span><span class="op">(</span><span class="va">drugcost_tbl</span>, n <span class="op">=</span> <span class="va">n_samples</span>, hesim_data <span class="op">=</span> <span class="va">hesim_dat</span><span class="op">)</span></span></code></pre></div>
<p>Finally, we can also instantiate a <code><a href="../reference/StateVals.html">StateVals()</a></code> from a
fitted linear model and a corresponding dataset of class
<code>expanded_hesim_data</code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">medcost_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/expand.html">expand</a></span><span class="op">(</span><span class="va">hesim_dat</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"strategies"</span>, <span class="st">"patients"</span>, <span class="st">"states"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">medcostmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_StateVals.html">create_StateVals</a></span><span class="op">(</span><span class="va">medcosts_fit</span>, input_data <span class="op">=</span> <span class="va">medcost_data</span>, </span>
<span>                                 n <span class="op">=</span> <span class="va">n_samples</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="combining-the-statistical-models">Combining the statistical models<a class="anchor" aria-label="anchor" href="#combining-the-statistical-models"></a>
</h4>
<p>The PSM model is instantiated using <code>$new()</code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">psm</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/Psm.html">Psm</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>survival_models <span class="op">=</span> <span class="va">survmods</span>,</span>
<span>               utility_model <span class="op">=</span> <span class="va">utilitymod</span>,</span>
<span>               cost_models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>medical <span class="op">=</span> <span class="va">medcostmod</span>, </span>
<span>                                  drug <span class="op">=</span> <span class="va">drugcostmod</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="simulating-outcomes">Simulating outcomes<a class="anchor" aria-label="anchor" href="#simulating-outcomes"></a>
</h3>
<div class="section level4">
<h4 id="simulating-survival-curves">Simulating survival curves<a class="anchor" aria-label="anchor" href="#simulating-survival-curves"></a>
</h4>
<p>Survival curves are predicted by treatment strategy and patient with
the function <code>$sim_survival()</code>. We can quickly generate a
plot of survival curves (averaged across patients) by treatment strategy
using <code><a href="../reference/autoplot.survival.html">autoplot.survival()</a></code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simulate</span></span>
<span><span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">12</span>, by <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span></span>
<span><span class="va">psm</span><span class="op">$</span><span class="fu">sim_survival</span><span class="op">(</span>t <span class="op">=</span> <span class="va">times</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">psm</span><span class="op">$</span><span class="va">survival_</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    sample strategy_id patient_id grp_id curve     t  survival</span></span>
<span><span class="co">##     &lt;num&gt;       &lt;int&gt;      &lt;int&gt;  &lt;int&gt; &lt;num&gt; &lt;num&gt;     &lt;num&gt;</span></span>
<span><span class="co">## 1:      1           1          1      1     1   0.0 1.0000000</span></span>
<span><span class="co">## 2:      1           1          1      1     1   0.1 0.9189061</span></span>
<span><span class="co">## 3:      1           1          1      1     1   0.2 0.8411512</span></span>
<span><span class="co">## 4:      1           1          1      1     1   0.3 0.7688137</span></span>
<span><span class="co">## 5:      1           1          1      1     1   0.4 0.7019982</span></span>
<span><span class="co">## 6:      1           1          1      1     1   0.5 0.6405107</span></span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://ggplot2.tidyverse.org" class="external-link">"ggplot2"</a></span><span class="op">)</span></span>
<span><span class="va">labs</span><span class="op">$</span><span class="va">curve</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Curve 1"</span> <span class="op">=</span> <span class="fl">1</span>, <span class="st">"Curve 2"</span> <span class="op">=</span> <span class="fl">2</span>, <span class="st">"Curve 3"</span> <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">psm</span><span class="op">$</span><span class="va">survival_</span>, labels <span class="op">=</span> <span class="va">labs</span>,</span>
<span>         ci <span class="op">=</span> <span class="cn">TRUE</span>, ci_style <span class="op">=</span> <span class="st">"ribbon"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="psm_files/figure-html/survcurves-1.png" width="576"></p>
</div>
<div class="section level4">
<h4 id="simulating-health-state-probabilities">Simulating health state probabilities<a class="anchor" aria-label="anchor" href="#simulating-health-state-probabilities"></a>
</h4>
<p>After simulating survival, we can calculate the probability of being
in each of the four health states using <code>$sim_stateprobs()</code>.
At a given point in time, the probability of being in state 1 is the
survival probability from the first survival curve, the probability of
being in state 2 is the difference in survival probabilities between the
2nd and 1st curves, the probability of being in state 3 is the
difference in survival probabilities between the 3rd and 2nd curves, and
the probability of death is 1 minus the survival probability from curve
3.</p>
<p>While plots can be quickly generated with
<code><a href="../reference/autoplot.stateprobs.html">autoplot.stateprobs()</a></code>, the output is returned in a tidy
format (and stored as a field in the class named
<code>stateprobs_</code>) that facilitates creation of custom plots.
We’ll plot state probabilities for the 1st patient with the 30th
randomly sampled parameter set.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simulate</span></span>
<span><span class="va">psm</span><span class="op">$</span><span class="fu">sim_stateprobs</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">psm</span><span class="op">$</span><span class="va">stateprobs_</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    sample strategy_id patient_id grp_id state_id     t      prob</span></span>
<span><span class="co">##     &lt;num&gt;       &lt;int&gt;      &lt;int&gt;  &lt;int&gt;    &lt;int&gt; &lt;num&gt;     &lt;num&gt;</span></span>
<span><span class="co">## 1:      1           1          1      1        1   0.0 1.0000000</span></span>
<span><span class="co">## 2:      1           1          1      1        1   0.1 0.9189061</span></span>
<span><span class="co">## 3:      1           1          1      1        1   0.2 0.8411512</span></span>
<span><span class="co">## 4:      1           1          1      1        1   0.3 0.7688137</span></span>
<span><span class="co">## 5:      1           1          1      1        1   0.4 0.7019982</span></span>
<span><span class="co">## 6:      1           1          1      1        1   0.5 0.6405107</span></span></code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot</span></span>
<span><span class="va">stateprobs</span> <span class="op">&lt;-</span> <span class="va">psm</span><span class="op">$</span><span class="va">stateprobs_</span><span class="op">[</span><span class="va">sample</span> <span class="op">==</span> <span class="fl">30</span> <span class="op">&amp;</span> <span class="va">patient_id</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">stateprobs</span><span class="op">[</span>, <span class="va">state</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">state_id</span>, </span>
<span>                             levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">state_id</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">stateprobs</span><span class="op">[</span>, <span class="va">strategy</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">strategy_id</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">labs</span><span class="op">$</span><span class="va">strategy_id</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">stateprobs</span><span class="op">[</span><span class="va">strategy_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">]</span>,</span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">t</span>, y <span class="op">=</span> <span class="va">prob</span>, fill <span class="op">=</span> <span class="va">state</span>, group <span class="op">=</span> <span class="va">state</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_area</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.65</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">strategy</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Years"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Proportion in state"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Health state"</span>,</span>
<span>                    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gray92"</span>, <span class="st">"green4"</span>, <span class="st">"orange"</span>, <span class="st">"purple"</span><span class="op">)</span>,</span>
<span>                    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Death"</span>, </span>
<span>                               <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">hesim_dat</span><span class="op">$</span><span class="va">states</span><span class="op">$</span><span class="va">state_name</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                             nrow <span class="op">=</span> <span class="fl">2</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="psm_files/figure-html/stateprobs-1.png" width="576"></p>
</div>
<div class="section level4">
<h4 id="simulating-costs-and-qalys">Simulating costs and QALYs<a class="anchor" aria-label="anchor" href="#simulating-costs-and-qalys"></a>
</h4>
<p>Finally, we can simulate discounted costs and QALYs by numerically
integrating the “weighted” probabilities in <code>$stateprobs_</code> as
described above. Costs and QALYs are produced for each treatment
strategy, patient, health state, and sampled parameter set.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Costs</span></span>
<span><span class="va">psm</span><span class="op">$</span><span class="fu">sim_costs</span><span class="op">(</span>dr <span class="op">=</span> <span class="fl">.03</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">psm</span><span class="op">$</span><span class="va">costs_</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    sample strategy_id patient_id grp_id state_id    dr category    costs</span></span>
<span><span class="co">##     &lt;num&gt;       &lt;int&gt;      &lt;int&gt;  &lt;int&gt;    &lt;int&gt; &lt;num&gt;   &lt;char&gt;    &lt;num&gt;</span></span>
<span><span class="co">## 1:      1           1          1      1        1  0.03  medical 28707.06</span></span>
<span><span class="co">## 2:      1           1          1      1        2  0.03  medical 24729.36</span></span>
<span><span class="co">## 3:      1           1          1      1        3  0.03  medical 24914.92</span></span>
<span><span class="co">## 4:      1           1          2      1        1  0.03  medical 27384.46</span></span>
<span><span class="co">## 5:      1           1          2      1        2  0.03  medical 23700.48</span></span>
<span><span class="co">## 6:      1           1          2      1        3  0.03  medical 23230.48</span></span></code></pre>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># QALYs</span></span>
<span><span class="va">psm</span><span class="op">$</span><span class="fu">sim_qalys</span><span class="op">(</span>dr <span class="op">=</span> <span class="fl">.03</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">psm</span><span class="op">$</span><span class="va">qalys_</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    sample strategy_id patient_id grp_id state_id    dr     qalys       lys</span></span>
<span><span class="co">##     &lt;num&gt;       &lt;int&gt;      &lt;int&gt;  &lt;int&gt;    &lt;int&gt; &lt;num&gt;     &lt;num&gt;     &lt;num&gt;</span></span>
<span><span class="co">## 1:      1           1          1      1        1  0.03 0.8913423 1.0479377</span></span>
<span><span class="co">## 2:      1           1          1      1        2  0.03 0.5448242 0.7391231</span></span>
<span><span class="co">## 3:      1           1          1      1        3  0.03 0.5277850 0.7778092</span></span>
<span><span class="co">## 4:      1           1          2      1        1  0.03 0.8502762 0.9996569</span></span>
<span><span class="co">## 5:      1           1          2      1        2  0.03 0.5221563 0.7083712</span></span>
<span><span class="co">## 6:      1           1          2      1        3  0.03 0.4921027 0.7252234</span></span></code></pre>
</div>
</div>
</div>
<div class="section level2">
<h2 id="decision-analysis">Decision analysis<a class="anchor" aria-label="anchor" href="#decision-analysis"></a>
</h2>
<p>A cost-effectiveness analysis can be performed with the
<code><a href="../reference/cea.html">cea()</a></code> and <code><a href="../reference/cea.html">cea_pw()</a></code> functions after using the
<code>$summarize()</code> method to create a <code><a href="../reference/ce.html">hesim::ce</a></code>
object with mean costs and QALYs computed for each PSA sample. Details
are provided in the <a href="cea.html">cost-effectiveness analysis</a>
vignette.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ce_sim</span> <span class="op">&lt;-</span> <span class="va">psm</span><span class="op">$</span><span class="fu">summarize</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">cea_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cea.html">cea</a></span><span class="op">(</span><span class="va">ce_sim</span>, dr_qalys <span class="op">=</span> <span class="fl">.03</span>, dr_costs <span class="op">=</span> <span class="fl">.03</span><span class="op">)</span></span>
<span><span class="va">cea_pw_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cea.html">cea_pw</a></span><span class="op">(</span><span class="va">ce_sim</span>, comparator <span class="op">=</span> <span class="fl">1</span>, dr_qalys <span class="op">=</span> <span class="fl">.03</span>, dr_costs <span class="op">=</span> <span class="fl">.03</span><span class="op">)</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Devin Incerti, Jeroen P. Jansen, Mark Clements.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
